<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ngọc Lan - Quản lý đơn hàng thông minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            background-color: #f0f9ff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .app-icon-circle {
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center; justify-content: center;
            color: white; font-weight: 800; font-size: 22px;
            box-shadow: 0 4px 10px rgba(29, 78, 216, 0.3);
        }
        .btn-active:active { transform: scale(0.96); }
        
        #invoice-template {
            position: absolute; left: -9999px; top: -9999px;
            width: 500px; background: white; padding: 40px; color: #1e293b;
        }
        .invoice-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .invoice-table th { border-bottom: 2px solid #334155; padding: 10px 5px; text-align: left; font-size: 14px; text-transform: uppercase; }
        .invoice-table td { border-bottom: 1px solid #e2e8f0; padding: 12px 5px; font-size: 15px; }

        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: white; margin: 5% auto; padding: 24px; border-radius: 32px;
            width: 95%; max-width: 500px; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .ai-shimmer {
            background: linear-gradient(90deg, #f3f4f6 0%, #e0e7ff 50%, #f3f4f6 100%);
            background-size: 200% 100%; animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-blue-50 text-slate-800 pb-40">

    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col">
        <!-- HEADER -->
        <header class="bg-blue-700 pt-8 pb-12 px-6 rounded-b-[40px] text-white relative z-10 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="app-icon-circle">NL</div>
                    <div>
                        <h1 class="text-xl font-black tracking-tight leading-none">NGỌC LAN</h1>
                        <p class="text-[10px] uppercase tracking-widest opacity-70 mt-1">Smart Sales System</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleHistory()" class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-md btn-active">
                        <i data-lucide="history" class="w-5 h-5"></i>
                    </button>
                    <button onclick="analyzeHistory()" class="w-10 h-10 bg-amber-400 text-blue-900 rounded-2xl flex items-center justify-center shadow-lg btn-active">
                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- THÔNG TIN KHÁCH HÀNG -->
        <div class="mx-5 -mt-6 bg-white rounded-3xl p-5 shadow-xl relative z-20 border border-blue-50">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                    <i data-lucide="user" class="w-4 h-4"></i>
                </div>
                <input type="text" id="customerName" placeholder="Tên khách hàng..." class="flex-1 font-bold text-blue-900 focus:outline-none text-lg">
            </div>
            <div class="pl-11">
                <textarea id="customerNote" placeholder="Địa chỉ, SĐT..." rows="1" class="w-full text-sm text-slate-400 focus:outline-none resize-none overflow-hidden"></textarea>
            </div>
        </div>

        <!-- FORM NHẬP SẢN PHẨM -->
        <div class="m-5 bg-white rounded-3xl p-6 shadow-xl border border-blue-50 space-y-4">
            <div class="flex items-center gap-3 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <i data-lucide="shopping-bag" class="text-blue-500 w-5 h-5"></i>
                <input type="text" id="prodName" placeholder="Tên sản phẩm..." class="bg-transparent flex-1 focus:outline-none font-medium">
            </div>

            <div class="flex items-center gap-3 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <i data-lucide="tag" class="text-blue-400 w-5 h-5"></i>
                <input type="text" id="prodNote" placeholder="Ghi chú (giảm 10%)..." class="bg-transparent flex-1 focus:outline-none text-sm italic">
            </div>

            <div class="flex gap-3">
                <div class="flex-1 flex items-center gap-2 bg-blue-50 p-4 rounded-2xl">
                    <span class="text-blue-600 font-bold">₫</span>
                    <input type="number" id="prodPrice" placeholder="Đơn giá" class="bg-transparent w-full focus:outline-none font-bold text-blue-700">
                </div>
                <div class="w-28 flex items-center justify-between bg-slate-50 px-3 py-2 rounded-2xl border border-slate-100">
                    <button onclick="changeQty(-1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-xl shadow-sm btn-active"><i data-lucide="minus" class="w-4 h-4 text-slate-500"></i></button>
                    <span id="prodQty" class="font-bold text-lg">1</span>
                    <button onclick="changeQty(1)" class="w-8 h-8 flex items-center justify-center bg-blue-600 rounded-xl shadow-sm btn-active"><i data-lucide="plus" class="w-4 h-4 text-white"></i></button>
                </div>
            </div>

            <button onclick="addToCart()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all btn-active shadow-lg shadow-blue-200">
                <i data-lucide="plus-circle" class="w-5 h-5"></i> THÊM VÀO ĐƠN
            </button>
        </div>

        <!-- AI SUGGESTIONS CHIP -->
        <div id="aiSuggestionBox" class="mx-5 mb-4 hidden">
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-2xl border border-blue-100 relative overflow-hidden">
                <div class="flex items-center gap-2 text-indigo-600 font-bold text-xs mb-2">
                    <i data-lucide="sparkles" class="w-3 h-3"></i> TƯ VẤN THÊM ✨
                </div>
                <div id="aiSuggestionText" class="text-xs text-slate-600 leading-relaxed italic"></div>
            </div>
        </div>

        <!-- DANH SÁCH ĐƠN HÀNG -->
        <div class="flex-1 px-5 mb-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-slate-400 font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                    Chi tiết đơn hàng <span id="itemCount" class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full text-[10px]">0</span>
                </h3>
                <button id="aiContentBtn" onclick="generateMarketingContent()" class="text-indigo-600 text-[10px] font-bold uppercase flex items-center gap-1 bg-indigo-50 px-3 py-1.5 rounded-full hover:bg-indigo-100 transition-colors hidden">
                    <i data-lucide="pen-tool" class="w-3 h-3"></i> ✨ Viết nội dung
                </button>
            </div>
            <div id="cartItems" class="space-y-3">
                <div id="emptyCart" class="text-center py-10 opacity-30 italic text-sm">Chưa có sản phẩm nào</div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white p-6 rounded-t-[40px] shadow-[0_-15px_30px_rgba(0,0,0,0.08)] z-50">
            <div class="flex justify-between items-center mb-6 px-2">
                <div>
                    <span class="text-slate-400 font-bold text-[10px] uppercase tracking-widest block">Tổng thanh toán</span>
                    <div id="totalDiscountDisplay" class="text-red-500 text-xs font-medium">Giảm giá: 0₫</div>
                </div>
                <span id="grandTotal" class="text-3xl font-black text-blue-900 tracking-tighter">0₫</span>
            </div>
            
            <div class="grid grid-cols-4 gap-3">
                <button onclick="resetApp()" class="bg-slate-100 text-slate-400 rounded-2xl flex items-center justify-center btn-active border border-slate-200 aspect-square">
                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                </button>
                <button onclick="saveOrderToHistory()" class="bg-emerald-50 text-emerald-600 rounded-2xl flex flex-col items-center justify-center btn-active border border-emerald-100">
                    <i data-lucide="save" class="w-5 h-5 mb-1"></i>
                    <span class="text-[10px] font-bold uppercase">Lưu Đơn</span>
                </button>
                <button id="zaloBtn" onclick="sendZalo()" class="col-span-2 bg-blue-600 text-white py-4 rounded-2xl font-black text-lg flex items-center justify-center gap-2 shadow-lg shadow-blue-200 btn-active">
                    <i data-lucide="message-circle" class="w-6 h-6"></i> GỬI ZALO
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL LỊCH SỬ ĐƠN HÀNG -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-blue-900 italic">LỊCH SỬ BÁN HÀNG</h2>
                <button onclick="toggleHistory()" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="mb-6 space-y-2">
                <button onclick="exportToCSV()" class="w-full bg-slate-100 text-slate-600 py-3 rounded-2xl font-bold flex items-center justify-center gap-2 border border-slate-200">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> XUẤT CSV
                </button>
                <button onclick="analyzeHistory()" class="w-full bg-indigo-600 text-white py-3 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-200">
                    <i data-lucide="sparkles" class="w-4 h-4"></i> ✨ PHÂN TÍCH KINH DOANH
                </button>
            </div>
            <div id="historyList" class="space-y-4"></div>
        </div>
    </div>

    <!-- AI RESULT MODAL -->
    <div id="aiModal" class="modal">
        <div class="modal-content bg-gradient-to-br from-white to-indigo-50">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2 text-indigo-600 font-black">
                    <i data-lucide="sparkles" class="w-5 h-5"></i> TRỢ LÝ AI NGỌC LAN
                </div>
                <button onclick="closeAiModal()" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="aiLoading" class="hidden">
                <div class="ai-shimmer h-40 rounded-2xl w-full mb-4"></div>
                <p class="text-center text-indigo-400 text-xs animate-pulse">Đang suy nghĩ...</p>
            </div>
            <div id="aiResult" class="text-sm text-slate-700 leading-relaxed space-y-3 whitespace-pre-wrap"></div>
            <button id="copyAiBtn" class="w-full mt-6 bg-white border border-indigo-200 text-indigo-600 py-3 rounded-xl font-bold text-xs uppercase hidden" onclick="copyAiContent()">
                <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i> Sao chép nội dung
            </button>
        </div>
    </div>

    <!-- LOADING NOTIFICATION -->
    <div id="syncToast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl z-[100] hidden flex items-center gap-3">
        <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
        Đang đồng bộ Google Sheets...
    </div>

    <!-- HÓA ĐƠN ẨN ĐỂ CHỤP ẢNH -->
    <div id="invoice-template">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
            <div>
                <h1 style="font-size: 28px; font-weight: 900; color: #1d4ed8; margin: 0;">NGỌC LAN</h1>
                <p style="font-size: 12px; color: #64748b; letter-spacing: 2px; margin-top: 5px;">HỆ THỐNG BÁN HÀNG</p>
            </div>
            <div style="text-align: right;">
                <p id="invoiceDate" style="font-size: 14px; color: #64748b; margin: 0;"></p>
                <p style="font-size: 14px; color: #1d4ed8; font-weight: bold; margin-top: 5px;">HÓA ĐƠN BÁN LẺ</p>
            </div>
        </div>
        <div style="background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
            <p style="margin: 0 0 5px 0; font-size: 12px; color: #94a3b8; font-weight: bold; text-transform: uppercase;">Khách hàng</p>
            <h2 id="invCustomerName" style="margin: 0; font-size: 18px; font-weight: 800; color: #0f172a;">Khách lẻ</h2>
            <p id="invCustomerNote" style="margin: 5px 0 0 0; font-size: 14px; color: #64748b;"></p>
        </div>
        <table class="invoice-table">
            <thead>
                <tr>
                    <th style="width: 45%;">Tên hàng</th>
                    <th style="width: 10%; text-align: center;">SL</th>
                    <th style="width: 20%; text-align: right;">Giá</th>
                    <th style="width: 25%; text-align: right;">Tổng</th>
                </tr>
            </thead>
            <tbody id="invItemsBody"></tbody>
        </table>
        <div style="margin-top: 30px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span style="color: #64748b; font-size: 14px;">Tạm tính:</span><span id="invSubtotal" style="font-weight: bold; font-size: 14px;">0₫</span></div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #ef4444;"><span style="font-size: 14px;">Chiết khấu:</span><span id="invDiscount" style="font-weight: bold; font-size: 14px;">-0₫</span></div>
            <div style="display: flex; justify-content: space-between; margin-top: 15px;"><span style="font-size: 18px; font-weight: 900; color: #1e293b;">TỔNG CỘNG:</span><span id="invGrandTotal" style="font-size: 22px; font-weight: 900; color: #1d4ed8;">0₫</span></div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        // URL của Google Apps Script (Bạn cần triển khai Script này để lưu vào Sheets)
        const GOOGLE_SHEET_APP_URL = "https://script.google.com/macros/s/AKfycbxDI-y8BiteBm1fww-nCazIUvxu5IZ3_SkatwxcZEcigKP_SlGdnnFiASRLCWv9AbOH7g/exec"; 

        lucide.createIcons();
        
        let currentQty = 1;
        let cart = [];
        let orderHistory = JSON.parse(localStorage.getItem('ngoclan_orders')) || [];

        // --- GEMINI API HELPERS ---
        async function callGemini(prompt, systemInstruction = "Bạn là trợ lý bán hàng chuyên nghiệp cho shop Ngọc Lan.") {
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            let retries = 0;
            const delays = [1000, 2000, 4000, 8000, 16000];

            while (retries < 5) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error("API Error");
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Không có phản hồi từ AI.";
                } catch (err) {
                    await new Promise(r => setTimeout(r, delays[retries]));
                    retries++;
                }
            }
            return "Xin lỗi, AI đang gặp sự cố. Vui lòng thử lại sau.";
        }

        // --- GOOGLE SHEETS SYNC ---
        async function syncToGoogleSheets(orderData) {
            if (!GOOGLE_SHEET_APP_URL) return; // Bỏ qua nếu chưa cấu hình URL

            const toast = document.getElementById('syncToast');
            toast.classList.remove('hidden');

            try {
                // Sử dụng fetch với chế độ no-cors vì Apps Script thường trả về redirect
                await fetch(GOOGLE_SHEET_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                console.log("Đã gửi yêu cầu đồng bộ Sheets");
            } catch (error) {
                console.error("Lỗi đồng bộ Sheets:", error);
            } finally {
                setTimeout(() => toast.classList.add('hidden'), 2000);
            }
        }

        // --- CORE APP LOGIC ---
        function changeQty(val) {
            currentQty = Math.max(1, currentQty + val);
            document.getElementById('prodQty').innerText = currentQty;
        }

        function calculateDiscount(price, qty, note) {
            const discountMatch = note.match(/(\d+)%/);
            if (discountMatch) {
                const percent = parseInt(discountMatch[1]);
                return (price * qty * percent) / 100;
            }
            return 0;
        }

        async function addToCart() {
            const name = document.getElementById('prodName').value;
            const note = document.getElementById('prodNote').value;
            const price = parseFloat(document.getElementById('prodPrice').value);
            
            if (!name || isNaN(price)) {
                alert("Vui lòng nhập tên và giá sản phẩm!");
                return;
            }

            const discountAmount = calculateDiscount(price, currentQty, note);
            const subtotal = (price * currentQty) - discountAmount;

            cart.push({ id: Date.now(), name, note, price, qty: currentQty, discount: discountAmount, total: subtotal });

            renderCart();
            suggestCrossSell(name); 
            
            document.getElementById('prodName').value = '';
            document.getElementById('prodNote').value = '';
            document.getElementById('prodPrice').value = '';
            currentQty = 1;
            document.getElementById('prodQty').innerText = 1;
            
            document.getElementById('aiContentBtn').classList.remove('hidden');
        }

        async function suggestCrossSell(itemName) {
            const box = document.getElementById('aiSuggestionBox');
            const text = document.getElementById('aiSuggestionText');
            box.classList.remove('hidden');
            text.innerText = "Đang tìm gợi ý...";
            
            const prompt = `Khách vừa chọn mua "${itemName}". Hãy gợi ý 2 sản phẩm khác thường đi kèm để shop Ngọc Lan tư vấn khách mua thêm. Chỉ viết 1 câu ngắn gọn, thân thiện.`;
            const suggestion = await callGemini(prompt);
            text.innerText = suggestion;
            lucide.createIcons();
        }

        async function generateMarketingContent() {
            if (cart.length === 0) return;
            openAiModal();
            const items = cart.map(i => i.name).join(', ');
            const prompt = `Dựa trên danh sách sản phẩm này: ${items}. Hãy viết một nội dung tin nhắn Zalo ngắn gọn, hào hứng để shop Ngọc Lan mời khách hàng mua thêm hoặc giới thiệu chương trình ưu đãi. Thêm emoji phù hợp.`;
            const content = await callGemini(prompt);
            showAiResult(content);
        }

        async function analyzeHistory() {
            if (orderHistory.length === 0) { alert("Chưa có lịch sử để phân tích!"); return; }
            openAiModal();
            const data = orderHistory.slice(0, 10).map(o => `${o.timestamp}: ${o.customer} mua ${o.items} - Tổng ${o.total}₫`).join('\n');
            const prompt = `Đây là dữ liệu 10 đơn hàng gần nhất của shop Ngọc Lan:\n${data}\n\nHãy phân tích xu hướng mua sắm (khách thích gì, mặt hàng nào hot) và đưa ra 3 lời khuyên ngắn gọn để tăng doanh thu. Trình bày dạng danh sách gạch đầu dòng.`;
            const analysis = await callGemini(prompt);
            showAiResult(analysis);
        }

        // --- UI HELPERS ---
        function openAiModal() {
            document.getElementById('aiModal').style.display = 'block';
            document.getElementById('aiLoading').classList.remove('hidden');
            document.getElementById('aiResult').innerText = '';
            document.getElementById('copyAiBtn').classList.add('hidden');
        }

        function showAiResult(text) {
            document.getElementById('aiLoading').classList.add('hidden');
            document.getElementById('aiResult').innerText = text;
            document.getElementById('copyAiBtn').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeAiModal() {
            document.getElementById('aiModal').style.display = 'none';
        }

        function copyAiContent() {
            const text = document.getElementById('aiResult').innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("Đã sao chép vào bộ nhớ tạm!");
        }

        function removeItems(id) {
            cart = cart.filter(item => item.id !== id);
            renderCart();
            if (cart.length === 0) {
                document.getElementById('aiContentBtn').classList.add('hidden');
                document.getElementById('aiSuggestionBox').classList.add('hidden');
            }
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center py-10 opacity-30 italic text-sm">Chưa có sản phẩm nào</div>';
                updateTotals();
                return;
            }
            container.innerHTML = cart.map(item => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-800">${item.name}</h4>
                        <div class="text-[11px] text-slate-400">SL: ${item.qty} • Giá: ${item.price.toLocaleString()}₫</div>
                        ${item.note ? `<div class="text-[11px] text-blue-500 mt-1 italic font-medium">${item.note}</div>` : ''}
                    </div>
                    <div class="text-right flex items-center gap-3">
                        <div class="font-black text-blue-700">${item.total.toLocaleString()}₫</div>
                        <button onclick="removeItems(${item.id})" class="text-slate-300 hover:text-red-500"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
            updateTotals();
        }

        function updateTotals() {
            const grandTotal = cart.reduce((sum, item) => sum + item.total, 0);
            const totalDiscount = cart.reduce((sum, item) => sum + item.discount, 0);
            document.getElementById('grandTotal').innerText = grandTotal.toLocaleString() + '₫';
            document.getElementById('totalDiscountDisplay').innerText = `Giảm giá: ${totalDiscount.toLocaleString()}₫`;
            document.getElementById('itemCount').innerText = cart.length;
        }

        function saveOrderToHistory() {
            if (cart.length === 0) { alert("Không có sản phẩm để lưu!"); return; }
            const customer = document.getElementById('customerName').value || "Khách lẻ";
            const note = document.getElementById('customerNote').value;
            const total = cart.reduce((sum, item) => sum + item.total, 0);
            
            const newOrder = {
                timestamp: new Date().toLocaleString('vi-VN'),
                customer: customer,
                note: note,
                items: cart.map(i => `${i.name} (${i.qty})`).join(', '),
                total: total
            };

            // Lưu Local Storage
            orderHistory.unshift(newOrder);
            localStorage.setItem('ngoclan_orders', JSON.stringify(orderHistory));

            // Đồng bộ Google Sheets (Drive)
            syncToGoogleSheets(newOrder);

            alert(`✅ Đã lưu đơn hàng của ${customer}!`);
            resetApp(false);
        }

        function toggleHistory() {
            const modal = document.getElementById('historyModal');
            const isOpen = modal.style.display === 'block';
            modal.style.display = isOpen ? 'none' : 'block';
            if (!isOpen) renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if (orderHistory.length === 0) {
                list.innerHTML = '<p class="text-center text-slate-400 py-10 italic">Chưa có lịch sử bán hàng.</p>';
                return;
            }
            list.innerHTML = orderHistory.map((order, idx) => `
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">${order.timestamp}</span>
                        <span class="text-blue-600 font-black">${order.total.toLocaleString()}₫</span>
                    </div>
                    <div class="font-bold text-slate-800">${order.customer}</div>
                    <div class="text-[11px] text-slate-500 line-clamp-1">${order.items}</div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function exportToCSV() {
            if (orderHistory.length === 0) return;
            let csvContent = "\uFEFFTime,Customer,Note,Items,Total\n";
            orderHistory.forEach(order => {
                csvContent += `"${order.timestamp}","${order.customer}","${order.note || ''}","${order.items}",${order.total}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `NgocLan_BaoCao_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.csv`;
            link.click();
        }

        async function sendZalo() {
            if (cart.length === 0) { alert("Đơn hàng trống!"); return; }
            const zaloBtn = document.getElementById('zaloBtn');
            const originalHtml = zaloBtn.innerHTML;
            zaloBtn.innerHTML = `Đang tạo ảnh...`;

            const customer = document.getElementById('customerName').value || "Khách lẻ";
            const customerNote = document.getElementById('customerNote').value;
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discount = cart.reduce((sum, item) => sum + item.discount, 0);
            const grandTotal = subtotal - discount;

            document.getElementById('invCustomerName').innerText = customer;
            document.getElementById('invCustomerNote').innerText = customerNote;
            document.getElementById('invoiceDate').innerText = 'Ngày: ' + new Date().toLocaleDateString('vi-VN');
            document.getElementById('invSubtotal').innerText = subtotal.toLocaleString() + '₫';
            document.getElementById('invDiscount').innerText = '-' + discount.toLocaleString() + '₫';
            document.getElementById('invGrandTotal').innerText = grandTotal.toLocaleString() + '₫';

            const itemsBody = document.getElementById('invItemsBody');
            itemsBody.innerHTML = cart.map(item => `
                <tr>
                    <td><div style="font-weight: bold;">${item.name}</div></td>
                    <td style="text-align: center;">${item.qty}</td>
                    <td style="text-align: right;">${item.price.toLocaleString()}</td>
                    <td style="text-align: right; font-weight: bold;">${item.total.toLocaleString()}</td>
                </tr>
            `).join('');

            try {
                const canvas = await html2canvas(document.getElementById('invoice-template'), { scale: 3, useCORS: true });
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `hoa-don-${customer}.png`, { type: 'image/png' });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({ files: [file], title: 'Hóa đơn Ngọc Lan' });
                    } else {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL();
                        link.download = `hoa-don-${customer}.png`;
                        link.click();
                    }
                    zaloBtn.innerHTML = originalHtml;
                    lucide.createIcons();
                });
            } catch (err) {
                zaloBtn.innerHTML = originalHtml;
                lucide.createIcons();
                alert("Lỗi tạo hóa đơn.");
            }
        }

        function resetApp(confirmNeeded = true) {
            if(!confirmNeeded || confirm("Xóa đơn hàng hiện tại?")) {
                cart = [];
                document.getElementById('customerName').value = '';
                document.getElementById('customerNote').value = '';
                document.getElementById('aiContentBtn').classList.add('hidden');
                document.getElementById('aiSuggestionBox').classList.add('hidden');
                renderCart();
            }
        }
    </script>
</body>
</html>
